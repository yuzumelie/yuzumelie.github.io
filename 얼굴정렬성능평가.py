# -*- coding: utf-8 -*-
"""ì–¼êµ´ì •ë ¬ì„±ëŠ¥í‰ê°€.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1LSgC_rXc_pFk2nHcMa-RMFziOj14yxzi
"""

#@title 1. ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (ì²« 1íšŒë§Œ ì‹¤í–‰)#@title 1. ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (ì²« 1íšŒë§Œ ì‹¤í–‰)
!pip install opencv-python-headless mediapipe ipywidgets

#@title 2. í•œê¸€ í°íŠ¸ ì„¤ì¹˜ (ì²« 1íšŒë§Œ ì‹¤í–‰)
!sudo apt-get install -y fonts-nanum*

#@title 3. Google Drive ë§ˆìš´íŠ¸
from google.colab import drive
import os
drive.mount('/content/drive')
print("\nâœ… Google Driveê°€ '/content/drive'ì— ë§ˆìš´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.")

#@title 4. ê°€ì´ë“œ ìŒì„± íŒŒì¼ ê²½ë¡œ ì„¤ì •
# [!!!] 4ê°œì˜ MP3 íŒŒì¼(perfect, not_found, all_in, move_back)ì´ ë“¤ì–´ìˆëŠ” ê²½ë¡œ ì…ë ¥
audio_folder_path = "/content/drive/MyDrive/audio" # 4ê°œì˜ ì‹ ê·œ ìŒì„± íŒŒì¼ì´ ìˆëŠ” ê²½ë¡œ

# [ìˆ˜ì •] íŒŒì¼ ê²½ë¡œ í™•ì¸ (4ê°œ íŒŒì¼ í™•ì¸)
required_files = ["perfect.mp3", "not_found.mp3", "all_in.mp3", "move_back.mp3"]
missing_files = []
if not os.path.isdir(audio_folder_path):
    print(f"âš ï¸ ê²½ê³ : '{audio_folder_path}'ëŠ” ìœ íš¨í•œ í´ë”ê°€ ì•„ë‹™ë‹ˆë‹¤.")
else:
    for f in required_files:
        if not os.path.exists(os.path.join(audio_folder_path, f)):
            missing_files.append(f)

if not missing_files:
    print("\nâœ… ëª¨ë“  ìŒì„± íŒŒì¼ ê²½ë¡œ í™•ì¸ ì™„ë£Œ.")
else:
    print(f"\nâš ï¸ ê²½ê³ : {audio_folder_path} í´ë” ëˆ„ë½ íŒŒì¼: {missing_files}")

#@title 5. [Aì½”ë“œ] ë¹„ë””ì˜¤ íŒŒì¼ + ë¶„ë¦¬ëœ ì˜¤ë””ì˜¤ë¡œ ì–¼êµ´ ì •ë ¬ ì‹¤í–‰

import cv2
import mediapipe as mp
import numpy as np
from google.colab.patches import cv2_imshow
# [ìˆ˜ì •] ì˜¤ë””ì˜¤ ì¬ìƒì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸
from IPython.display import display, Javascript, Audio
from IPython.display import clear_output
from ipywidgets import Output # [ìˆ˜ì •] google.colabì´ ì•„ë‹Œ ipywidgetsì—ì„œ ì„í¬íŠ¸
import base64
from PIL import ImageFont, ImageDraw, Image
import time
import json
import os

# --- 0. [ì‹ ê·œ] ì˜¤ë””ì˜¤ ì¬ìƒì„ ìœ„í•œ ë³„ë„ ì¶œë ¥ ì…€ ìƒì„± ---
# ë¹„ë””ì˜¤(cv2_imshow)ì™€ ì˜¤ë””ì˜¤(display)ì˜ ì¶©ëŒì„ ë§‰ê¸° ìœ„í•´ ì…€ì„ ë¶„ë¦¬
audio_output = Output()
print("ì˜¤ë””ì˜¤ ì¶œë ¥ ì…€ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.")

# --- 1. í•œê¸€ í°íŠ¸ ì„¤ì • ---
font_path = '/usr/share/fonts/truetype/nanum/NanumGothic.ttf'
try:
    font = ImageFont.truetype(font_path, 24)
except IOError:
    print(f"í°íŠ¸ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {font_path}")
    font = ImageFont.load_default()

# --- 2. MediaPipe Face Mesh ì´ˆê¸°í™” ---
mp_face_mesh = mp.solutions.face_mesh
face_mesh = mp_face_mesh.FaceMesh(
    max_num_faces=5, # ìµœëŒ€ 5ëª…ê¹Œì§€ ì¸ì‹
    refine_landmarks=True,
    min_detection_confidence=0.5,
    min_tracking_confidence=0.5)

# --- 3. ìë™ í”„ë ˆì´ë° ë¡œì§ (í•µì‹¬) ---
global_guide_state = ""
last_audio_play_time = 0
face_not_visible_counter = 0
FACE_NOT_VISIBLE_THRESHOLD = 10 # ì•½ 1/3ì´ˆ

def check_auto_framing(multi_face_landmarks, frame_width, frame_height):
    global global_guide_state, last_audio_play_time, face_not_visible_counter

    message = ""
    new_state = ""
    is_well_framed = False
    face_detected = bool(multi_face_landmarks)

    if face_detected:
        all_x, all_y = [], []
        for face_landmarks in multi_face_landmarks:
            for lm in face_landmarks.landmark:
                all_x.append(lm.x)
                all_y.append(lm.y)

        min_x, max_x = min(all_x), max(all_x)
        min_y, max_y = min(all_y), max(all_y)
        box_width, box_height = max_x - min_x, max_y - min_y
        is_mostly_visible = (min_x > 0.05 and max_x < 0.95 and min_y > 0.05 and max_y < 0.95)

        if is_mostly_visible:
            face_not_visible_counter = 0
            TARGET_WIDTH_RATIO, TARGET_HEIGHT_RATIO = 0.8, 0.8

            if box_width > TARGET_WIDTH_RATIO or box_height > TARGET_HEIGHT_RATIO:
                message = "ì¡°ê¸ˆ ë’¤ë¡œ ë¬¼ëŸ¬ë‚˜ì„¸ìš”"
                new_state = "move_back"
            else:
                message = "ì™„ë²½í•©ë‹ˆë‹¤!"
                new_state = "perfect"
                is_well_framed = True
        else:
            face_not_visible_counter += 1
            if face_not_visible_counter >= FACE_NOT_VISIBLE_THRESHOLD:
                 message = "ëª¨ë“  ë¶„ì´ í™”ë©´ ì•ˆìœ¼ë¡œ ë“¤ì–´ì˜¤ì„¸ìš”"
                 new_state = "all_in"
            else:
                 message = "ëª¨ë“  ë¶„ì´ í™”ë©´ ì•ˆìœ¼ë¡œ ë“¤ì–´ì˜¤ì„¸ìš”"
                 new_state = global_guide_state
    else:
        face_not_visible_counter += 1
        if face_not_visible_counter >= FACE_NOT_VISIBLE_THRESHOLD:
            message = "ì–¼êµ´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            new_state = "not_found"
        else:
            message = "ì–¼êµ´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            new_state = global_guide_state

    # [ìˆ˜ì •] ìŒì„± ì¬ìƒ ë¡œì§ (IPython.display.Audio ì‚¬ìš©)
    current_time = time.time()
    # "perfect"ê°€ ì•„ë‹ˆë©´ì„œ ìƒíƒœ ë³€ê²½ ì‹œ (2ì´ˆ ë”œë ˆì´)
    if new_state and new_state != "perfect" and new_state != global_guide_state and (current_time - last_audio_play_time > 2):
        global_guide_state = new_state
        last_audio_play_time = current_time
        try:
            # Google Drive ê²½ë¡œì—ì„œ MP3 íŒŒì¼ ê²½ë¡œ ìƒì„±
            audio_file_path = os.path.join(audio_folder_path, f"{new_state}.mp3")
            if os.path.exists(audio_file_path):
                # ë³„ë„ì˜ ì˜¤ë””ì˜¤ ì¶œë ¥ ì…€ì—ì„œ ì¬ìƒ
                with audio_output:
                    clear_output(wait=True) # ì´ì „ ì˜¤ë””ì˜¤ ìœ„ì ¯ ì‚­ì œ
                    display(Audio(audio_file_path, autoplay=True)) # ìƒˆ ì˜¤ë””ì˜¤ ì¬ìƒ
            else:
                print(f"ê²½ê³ : {audio_file_path} íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        except Exception as e:
            print(f"ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜: {e}")

    elif new_state == "perfect":
        # "perfect" ìƒíƒœì¼ ë•ŒëŠ” (ì†Œë¦¬ ì—†ì´) ê¸°ì¡´ ì†Œë¦¬ë§Œ ë”
        if global_guide_state != "perfect":
            with audio_output:
                 clear_output(wait=True) # ê¸°ì¡´ ì†Œë¦¬ ì •ì§€
        global_guide_state = "perfect"

    return message, is_well_framed

# --- 4. [ìˆ˜ì •] ë©”ì¸ ì‹¤í–‰ ë£¨í”„ (ë¹„ë””ì˜¤ íŒŒì¼) ---

# [!!!] Google Driveì— ìˆëŠ” ë³¸ì¸ì˜ í…ŒìŠ¤íŠ¸ ì˜ìƒ íŒŒì¼ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”
# --------------------------------------------------
my_video_path = "/content/drive/MyDrive/video/test.mov"
# --------------------------------------------------

print(f"'{my_video_path}' íŒŒì¼ì„ ì—´ì–´ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...")

if not required_files:
     print("âŒ ì˜¤ë¥˜: ì˜¤ë””ì˜¤ íŒŒì¼ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. '#@title 4' ì…€ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.")
else:
    # 1. ë¹„ë””ì˜¤ ìº¡ì²˜ ê°ì²´ ìƒì„±
    cap = cv2.VideoCapture(my_video_path)
    if not cap.isOpened():
        print(f"âŒ ì˜¤ë¥˜: ë¹„ë””ì˜¤ íŒŒì¼ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”: {my_video_path}")
        print("   (ì°¸ê³ : .mov íŒŒì¼ì€ ì½”ë± ë¬¸ì œë¡œ Colabì—ì„œ ì—´ë¦¬ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. .mp4ë¡œ ë³€í™˜í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.)")
    else:
        fps = cap.get(cv2.CAP_PROP_FPS)
        if fps == 0: fps = 30
        delay = 1 / fps
        print(f"ì˜ìƒ FPS: {fps:.2f} (í”„ë ˆì„ ë”œë ˆì´: {delay:.3f}ì´ˆ)")

        # [ì‹ ê·œ] ë¹„ë””ì˜¤ì™€ ë¶„ë¦¬ëœ ì˜¤ë””ì˜¤ ì¶œë ¥ ì…€ì„ í‘œì‹œ
        display(audio_output)
        print("--- ë¹„ë””ì˜¤ ë¶„ì„ ì‹œì‘ (ì˜¤ë””ì˜¤ëŠ” ìœ„ ì…€ì—ì„œ ì¬ìƒë©ë‹ˆë‹¤) ---")

        # [ì‹ ê·œ] ì„±ëŠ¥ ì¸¡ì •ìš© ë³€ìˆ˜
        total_frames_processed = 0
        total_processing_time = 0

        try:
            while cap.isOpened():
                ret, frame = cap.read()
                if not ret:
                    print("\në¹„ë””ì˜¤ ì¬ìƒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
                    break

                # [ì„±ëŠ¥ ì¸¡ì • ì‹œì‘]
                start_time = time.time()

                image_rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
                results = face_mesh.process(image_rgb)
                frame_height, frame_width, _ = frame.shape

                # [ìˆ˜ì •] ê±°ìš¸ ëª¨ë“œ(flip)ê°€ ì•„ë‹ˆë¯€ë¡œ ì •ë°©í–¥ ì•ˆë‚´ ë¡œì§ í•„ìš”
                # (check_auto_framingì—ì„œ ì´ë¯¸ num_faces > 1 ë¡œì§ìœ¼ë¡œ ì²˜ë¦¬ë¨)
                message, is_well_framed = check_auto_framing(results.multi_face_landmarks, frame_width, frame_height)

                # [ì„±ëŠ¥ ì¸¡ì • ì¢…ë£Œ]
                duration = time.time() - start_time
                total_processing_time += duration
                total_frames_processed += 1

                # í•œê¸€ í…ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
                cv2.rectangle(frame, (0, 0), (frame_width, 40), (0, 0, 0), -1)
                frame_pil = Image.fromarray(cv2.cvtColor(frame, cv2.COLOR_BGR2RGB))
                draw = ImageDraw.Draw(frame_pil)

                text_color = (0, 255, 0) if is_well_framed else (255, 255, 255)
                draw.text((10, 5), message, font=font, fill=text_color)

                frame = cv2.cvtColor(np.array(frame_pil), cv2.COLOR_RGB2BGR)

                # ë¹„ë””ì˜¤ í”„ë ˆì„ ì¶œë ¥
                cv2_imshow(frame)

                # ì‹¤ì‹œê°„ ì¬ìƒì„ ìœ„í•´ FPSë§Œí¼ ë”œë ˆì´
                time.sleep(delay)

        except KeyboardInterrupt:
            print("ë¹„ë””ì˜¤ ì¬ìƒì„ ì¤‘ì§€í•©ë‹ˆë‹¤.")
        except Exception as e:
            print(f"ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ: {e}")
        finally:
            cap.release()
            print("ë¹„ë””ì˜¤ ë¦¬ì†ŒìŠ¤ë¥¼ í•´ì œí–ˆìŠµë‹ˆë‹¤.")

            # [ì‹ ê·œ] ìµœì¢… ì„±ëŠ¥ ë¦¬í¬íŠ¸
            if total_frames_processed > 0:
                avg_time_ms = (total_processing_time / total_frames_processed) * 1000
                avg_fps = 1.0 / (total_processing_time / total_frames_processed)

                print("\n\n" + "="*50)
                print("ğŸ‰ MediaPipe (Aì½”ë“œ) ì„±ëŠ¥ í‰ê°€ ì™„ë£Œ")
                print("="*50)
                print(f"  ì´ ë¶„ì„ í”„ë ˆì„ ìˆ˜: {total_frames_processed}ê°œ")
                print("\n--- 1. ì†ë„ (FPS) ---")
                print(f"  ì´ ì²˜ë¦¬ ì‹œê°„: {total_processing_time:.2f}ì´ˆ")
                print(f"  í”„ë ˆì„ 1ê°œë‹¹ í‰ê·  ì²˜ë¦¬ ì‹œê°„: {avg_time_ms:.2f} ms")
                print(f"  [í‰ê·  FPS (ì´ˆë‹¹ í”„ë ˆì„ ìˆ˜)]: {avg_fps:.2f} FPS")
            else:
                print("\nì„±ëŠ¥ í‰ê°€ ì‹¤íŒ¨: ì²˜ë¦¬ëœ í”„ë ˆì„ì´ ì—†ìŠµë‹ˆë‹¤.")